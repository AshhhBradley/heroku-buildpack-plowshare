#!/bin/sh

echo "-----> Installing Plowshare"
BUILD_DIR=$1
VENDOR="$BUILD_DIR/vendor"
mkdir -p $VENDOR
cd $VENDOR
DOWNLOAD_URL="https://raw.githubusercontent.com/self10/plowshare/master/src/core.sh"
curl -O --silent $DOWNLOAD_URL
chmod +x core.sh


DOWNLOAD_URL="https://raw.githubusercontent.com/self10/plowshare/master/src/delete.sh"
curl -O --silent $DOWNLOAD_URL
mv delete.sh plowdel
chmod +x plowdel
PROFILE_PATH="$BUILD_DIR/.profile.d/plowdel.sh"
echo 'export PATH="$PATH:${HOME}/vendor"' >> $PROFILE_PATH


DOWNLOAD_URL="https://raw.githubusercontent.com/self10/plowshare/master/src/download.sh"
curl -O --silent $DOWNLOAD_URL
mv download.sh plowdown
chmod +x plowdown
PROFILE_PATH="$BUILD_DIR/.profile.d/plowdown.sh"
echo 'export PATH="$PATH:${HOME}/vendor"' >> $PROFILE_PATH


DOWNLOAD_URL="https://raw.githubusercontent.com/self10/plowshare/master/src/list.sh"
curl -O --silent $DOWNLOAD_URL 
mv list.sh plowlist
chmod +x plowlist
PROFILE_PATH="$BUILD_DIR/.profile.d/plowlist.sh"
echo 'export PATH="$PATH:${HOME}/vendor"' >> $PROFILE_PATH


DOWNLOAD_URL="https://raw.githubusercontent.com/self10/plowshare/master/src/mod.sh"
curl -O --silent $DOWNLOAD_URL
mv mod.sh plowmod
chmod +x plowmod
PROFILE_PATH="$BUILD_DIR/.profile.d/plowmod.sh"
echo 'export PATH="$PATH:${HOME}/vendor"' >> $PROFILE_PATH


DOWNLOAD_URL="https://raw.githubusercontent.com/self10/plowshare/master/src/probe.sh"
curl -O --silent $DOWNLOAD_URL
mv probe.sh plowprobe
chmod +x plowprobe
PROFILE_PATH="$BUILD_DIR/.profile.d/plowprobe.sh"
echo 'export PATH="$PATH:${HOME}/vendor"' >> $PROFILE_PATH


DOWNLOAD_URL="https://raw.githubusercontent.com/self10/plowshare/master/src/upload.sh"
curl -O --silent $DOWNLOAD_URL
mv upload.sh plowup
chmod +x plowup
PROFILE_PATH="$BUILD_DIR/.profile.d/plowup.sh"
echo 'export PATH="$PATH:${HOME}/vendor"' >> $PROFILE_PATH


# bash plowmod --install

# wget http://ftp.mozilla.org/pub/spidermonkey/prereleases/59/pre1/mozjs-59.0a1.0.tar.bz2
# tar xvf mozjs-59.0a1.0.tar.bz2
# cd mozjs-59.0a1.0.tar.bz2

cd $BUILD_DIR
wget -P /tmp http://ftp.mozilla.org/pub/spidermonkey/prereleases/59/pre1/mozjs-59.0a1.0.tar.bz2
echo "-----> Extracting mozjs"
tar xf /tmp/mozjs-59.0a1.0.tar.bz2 -C $BUILD_DIR
echo "-----> Done"
cd $BUILD_DIR/mozjs-59.0a1.0.tar.bz2

wget -O bootstrap.py https://hg.mozilla.org/mozilla-central/raw-file/default/python/mozboot/bin/bootstrap.py && python bootstrap.py
wget https://ftp.gnu.org/gnu/autoconf/autoconf-2.13.tar.gz
tar -xvzf autoconf-2.13.tar.gz
cd autoconf-2.13/
./configure --program-suffix=2.13
make
make install
cd ..

cd js/src
# If it doesn't work, use autoconf2.13
autoconf-2.13

mkdir build_DBG.OBJ
cd build_DBG.OBJ

CFLAGS='-pg' CXXFLAGS='-pg' ../configure --enable-debug --disable-optimize
make

cd js/src/shell/
./js -e 'print("Test JS Interpreter")'

echo "-----> Done"
